var config=require("informations.config");
var MongoUrl="mongodb://"+config.user+":"+config.passward+"@"+config.host+":"+config.port+"/"+config.db_name;
var mongodb=require('mongodb');
var MongoClient=mongodb.MongoClient;
var nodemailer=require('nodemailer');
var transporter=nodemailer.createTransport('smtps://user%40gmail.com:pass@smtp.gmail.com');/*??*/
var db=require('Database').db;



var exp = { 
  'register' : function(req,res){
      db.find({'email':req.body.email}).count(function(err,cnt){
        if(cnt){
          res.end(JSON.stringify(false));
        }
        else{
          var key=gen();
          //verify email
          var mailDetail={
            from: '"jizz" <jizz@jizz.jizz>',
            to: req.body.email,
            subject: 'jizz',
            text: '/verify?key='+key+'&email='+req.body.email
          }
          transporter.sendMail(mailDetail,function(err,ret){
            if(err){
              throw err;
            }
            else{
              db.collections('users').insertOne({'email':req.body.email,'password':req.body.password,'nickname':req.body.nickname,'verified':0});
              db.collections('VER_KEY').insertOne({'email':req.body.email,'key':key});
              res.end(JSON.stringify(true));
            }
          })
        }
    })
  },
  'login' : function(req,res){
    db.collection('users').find({'email':req.email,'password':req.password}).count(function(err,cnt){
        if(!cnt){
            res.end(JSON.stringify(false));
        }
        else{
            res.end(JSON.stringify(/*?*/));
        }
    })
  },
  'verify' : function(req,res){
    var key=req.params.key;
    var email=req.params.email;
    var cursor=db.collection('VER_KEY').find({'email':email,'key':key});
    cursor.toArray(function(err,docs){
        if(err){
            throw err;
        }
        else{
            if(docs.length!=1){
                res.end("cant find this email||email>=2||!key");
            }
            else{
                var fd=db.collection('users').find({'email':email});
                fd.toArray(function(err,cb){
                    if(cb.length==1){
                        cb=cb[0];
                        var ued=cb;
                        ued.verified=1;
                        db.collection('users').update(cb,ued);
                        db.collection('VER_KEY').delete(docs[0]);
                        res.end("verified");
                    }
                    else{
                        res.end("key email !in userDB");
                    }
                })
            }
        }
    });

  },
  'logout' : function(req,res){
    var token=exp.key.forEach(function(element,index){
        if(element.KEY===req.cookies.key){
            exp.key.splice(index,1);
            res.end("success");
        }
    })
  },
  'key' :[]/*jizz*/
}

function gen(){
    var all="0123456789qweasdZSzxcvbnfghrtyuiojklmpQAWXEDCFRVTGYBHNUJIMOKLP".split("");
    var result="";
    for(var i=0;i<20;i++){
        result+=all[parseInt(Math.random()*all.length())];
    }
    return result;
}

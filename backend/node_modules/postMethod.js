var verify = require('verifyRecaptcha');
var arr_equal = require('array-equal');
module.exports = function(req, res, collection){
  if(verify(req.body.CAPTCHA_RESPONSE_TOKEN)){
    var cursor,db_question;
    var question_in_total = req.body.length;
    var correct,correct_option,solution,rank=0,result=[];
    req.body.forEach(function(client_upload_obj,client_upload_obj_index){
      cursor = collection.find({"id": client_upload_obj.id});
      cursor.toArray(function(err, docs){
        if(err) throw err;
        if(docs.length===0) res.end('no such question(id error)');
        db_question = docs[0];
        correct = arr_equal(client_upload_obj.options,db_question.answer)&&true;
        correct_option = db_question.answer;
        solution = db_question.solution;
        result.push({id:client_upload_obj.id,correctOrNot:correct,correctOptions:correct_option,solution:solution});
        if(correct)
          rank+=(100/question_in_total);
        if(client_upload_obj_index===question_in_total-1){
          result.rank = rank;
          res.end(JSON.stringify(result));
        }
      });
    });
  }
};

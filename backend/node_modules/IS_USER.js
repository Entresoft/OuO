var regist = require('regist');
var Db = require('Database')

/*
 * Because of that if you access this method equals that you allow the cookies go through
 * cookies contains email but nickname
 * So, i callback with nickname || false
 */

module.exports = function(req, callback){
  //regist.key.forEach(function(element){i
	if(regist.key.length===0){
		callback(false);
		return;
	}
	for(var k=0; k<regist.key.length; k++){
		console.log(`IS_USER key`)
		console.log(regist.key) // [{}]
		console.log(`IS_USER req.cookies`)
		console.log(req.cookies) // {}
		console.log(`IS_USER req.connection`)
		console.log(req.connection.remoteAddress) // {}
		var element = regist.key[k];
    if(element['token']===req.cookies.token && element['ip']===req.connection.remoteAddress){
      var cursor = Db.db.collection('users').find({email: element['email']});
      cursor.toArray(function(err, docs){
        if(err){
					console.log(err);
					callback(false)
					return;
				}
				if(docs.length===0){
					callback(false)
					return;
				}
				callback(docs[0]['nickname'])
      });
			break;
    }else if(k===regist.key.length-1){
    	callback(false)
    }
	}
  //});
}
